# å·²å®¡æ ¸æ¨¡å—æ¸…å•

è®°å½•å·²å®Œæˆå®¡æ ¸çš„æ¨¡å—ï¼Œé˜²æ­¢é‡å¤å®¡æ ¸ã€‚

> **å®¡æ ¸æ ‡å‡†ä¾æ®**: è¯¦è§ [.qoder/rules/shenhe.md](../../.qoder/rules/shenhe.md)

---

## âœ… å·²å®¡æ ¸æ¨¡å—

### 1. ç”¨æˆ·æ¨¡å— (User)
- **å®¡æ ¸æ—¶é—´**: 2026-01-25
- **å®¡æ ¸å†…å®¹**: 
  - [x] æ¨¡å‹å­—æ®µå®šä¹‰
  - [x] DTO ç™½åå•é…ç½®
  - [x] å¸¸é‡æšä¸¾å®šä¹‰
  - [x] å…³ç³»å…³è”é…ç½®
  - [x] é’©å­å‡½æ•°é€»è¾‘
- **ç›¸å…³æ–‡ä»¶**:
  - `src/models/user/index.ts`
  - `src/models/user/types/index.ts`
  - `docs/project/models/user.md`

### 2. è§’è‰²æ¨¡å— (Role)
- **å®¡æ ¸æ—¶é—´**: 2026-01-25
- **å®¡æ ¸å†…å®¹**:
  - [x] æ¨¡å‹å­—æ®µå®šä¹‰
  - [x] DTO ç™½åå•é…ç½®
  - [x] å¸¸é‡æšä¸¾å®šä¹‰
  - [x] å…³ç³»å…³è”é…ç½®
- **ç›¸å…³æ–‡ä»¶**:
  - `src/models/role/index.ts`
  - `src/models/role/types/index.ts`
  - `docs/project/models/role.md`

### 3. WebSocket æ¨¡å—
- **å®¡æ ¸æ—¶é—´**: 2026-01-26
- **å®¡æ ¸å†…å®¹**:
  - [x] äº‹ä»¶ç±»å‹å®šä¹‰ä¸€è‡´æ€§
  - [x] Payload ç±»å‹å­—æ®µåŒ¹é…
  - [x] äº‹ä»¶ç›‘å¬å™¨ç»‘å®š
- **ä¿®å¤å†…å®¹**:
  - ä¿®å¤ `FriendAcceptedPayload` å­—æ®µä¸åŒ¹é… (friendIdâ†’friendUser.id, userâ†’friendUser)
  - ä¿®å¤ `CallInvitePayload` ç§»é™¤ä¸å­˜åœ¨çš„ caller å­—æ®µ
  - ä¿®å¤ `CallRingPayload/CallAnswerPayload/CallRejectPayload/CallEndPayload` å­—æ®µå¯¹é½
  - ä¿®å¤ `friendStore.handleRequestAccepted` å­—æ®µè®¿é—®é”™è¯¯
  - ä¿®å¤ `callStore.handleIncomingCall` å­—æ®µè®¿é—®é”™è¯¯
  - æ·»åŠ  `messageStore.setupWsListeners` å¤„ç†æ¶ˆæ¯äº‹ä»¶
  - æ·»åŠ  `conversationStore.setupWsListeners` å¤„ç†è¾“å…¥çŠ¶æ€äº‹ä»¶
  - åœ¨ `App.tsx` ç»‘å®šæ¶ˆæ¯/ä¼šè¯ WebSocket ç›‘å¬
- **ç›¸å…³æ–‡ä»¶**:
  - `app/my-app/src/types/websocket.ts`
  - `app/my-app/src/types/call.ts`
  - `app/my-app/src/stores/friendStore.ts`
  - `app/my-app/src/stores/callStore.ts`
  - `app/my-app/src/stores/messageStore.ts`
  - `app/my-app/src/stores/conversationStore.ts`
  - `app/my-app/App.tsx`
  - `im/src/websocket/events/*.ts`

---

## ğŸ”§ å¾…å®¡æ ¸æ¨¡å—

### 3. è®¤è¯æ¨¡å— (Auth)
- **å®¡æ ¸æ—¶é—´**: 2026-01-26
- **å®¡æ ¸å†…å®¹**:
  - [x] ç™»å½•/æ³¨å†Œæµç¨‹
  - [x] Token ç®¡ç†æœºåˆ¶
  - [x] æƒé™éªŒè¯é€»è¾‘
- **å®¡æ ¸å‘ç°ä¸ä¿®å¤**:
  - âœ… æ³¨å†Œæµç¨‹å®Œæ•´ï¼šæ‰‹æœºå·æ ¼å¼éªŒè¯(10-15ä½)ã€å¯†ç å¼ºåº¦æ ¡éªŒ(6-128ä½)ã€PINç éªŒè¯(6ä½æ•°å­—)
  - âœ… ç™»å½•æµç¨‹å®‰å…¨ï¼šå¯†ç å“ˆå¸ŒéªŒè¯ã€é”™è¯¯ä¿¡æ¯æ¨¡ç³ŠåŒ–å¤„ç†
  - âœ… Token ç®¡ç†è§„èŒƒï¼šJWT åŒä»¤ç‰Œæœºåˆ¶(access/refresh)ã€è½½è·ç»“æ„æ¸…æ™°
  - âœ… æƒé™éªŒè¯å®Œå–„ï¼šrequireAuth ä¸­é—´ä»¶ã€è§’è‰²/ä½œç”¨åŸŸå®ˆå«ã€ç±»å‹æ‰©å±•å®Œæ•´
  - âœ… é”™è¯¯å¤„ç†ç»Ÿä¸€ï¼šHTTP çŠ¶æ€ç æ ‡å‡†åŒ–(401/404/409)ã€é”™è¯¯ä¿¡æ¯å›½é™…åŒ–å‹å¥½
- **ç›¸å…³æ–‡ä»¶**:
  - `src/services/auth.ts`
  - `src/routes/auth.ts`
  - `src/contracts/auth.controller.ts`
  - `src/models/auth/auth.ts`
  - `src/middleware/auth/index.ts`
  - `src/tools/jwt/index.ts`

### 2. API æ¥å£æ¨¡å—
- **å®¡æ ¸æ—¶é—´**: 2026-01-26
- **å®¡æ ¸å†…å®¹**:
  - [x] è¯·æ±‚å‚æ•°åŒ¹é…
  - [x] å“åº”æ•°æ®ç»“æ„
  - [x] API è·¯å¾„ä¸€è‡´æ€§
- **å®¡æ ¸å‘ç°ä¸ä¿®å¤**:
  - âœ… API è·¯å¾„è§„èŒƒï¼šRESTful è®¾è®¡(/auth/register, /auth/login, /auth/me)
  - âœ… è¯·æ±‚å‚æ•°éªŒè¯ï¼šå¿…å¡«å­—æ®µæ£€æŸ¥ã€æ ¼å¼æ ¡éªŒã€é•¿åº¦é™åˆ¶
  - âœ… å“åº”ç»“æ„ç»Ÿä¸€ï¼šä½¿ç”¨ CRUD å·¥å…·å°è£…(ok/created/badRequest/unauthorized)
  - âœ… å­—æ®µå¯¹é½æ£€æŸ¥ï¼šå‰åç«¯ç±»å‹å®šä¹‰ä¸€è‡´(RegisterRequest/LoginRequest)
  - âœ… æ–¹æ³•ç­¾åå¯¹é½ï¼šæ§åˆ¶å™¨æ–¹æ³•ä¸è·¯ç”±ç»‘å®šå‡†ç¡®
- **ç›¸å…³æ–‡ä»¶**:
  - `src/contracts/auth.controller.ts`
  - `src/routes/auth.ts`
  - `src/models/auth/auth.ts`
  - `src/contracts/crud/` (å“åº”å·¥å…·)

---

## ğŸ“ å®¡æ ¸æ ‡å‡†å‚è€ƒ

è¯¦ç»†å®¡æ ¸æ ‡å‡†è¯·å‚è§: [.qoder/rules/shenhe.md](../../.qoder/rules/shenhe.md)

### æ ¸å¿ƒå®¡æ ¸ç»´åº¦

1. **WebSocket äº‹ä»¶å®¡æ ¸**
   - äº‹ä»¶ç±»å‹ä¸€è‡´æ€§
   - Payload ç±»å‹å­—æ®µåŒ¹é…
   - äº‹ä»¶ç›‘å¬å™¨ç»‘å®š

2. **API æ¥å£å®¡æ ¸**
   - è¯·æ±‚å‚æ•°åŒ¹é…
   - å“åº”æ•°æ®ç»“æ„
   - API è·¯å¾„ä¸€è‡´æ€§
   - **APIå­—æ®µå¯¹é½æ£€æŸ¥**
     - å‰åç«¯å­—æ®µåä¸€è‡´æ€§
     - å­—æ®µç±»å‹åŒ¹é…ï¼ˆstring/number/booleanï¼‰
     - å¿…å¡«/å¯é€‰å­—æ®µæ ‡è¯†
     - åµŒå¥—å¯¹è±¡ç»“æ„å¯¹é½

3. **Store é€»è¾‘å®¡æ ¸**
   - æ–¹æ³•å‘½åä¸€è‡´æ€§
   - çŠ¶æ€æ›´æ–°é€»è¾‘
   - æ•°æ®è½¬æ¢æ­£ç¡®æ€§
   - **æ–¹æ³•å¯¹é½æ£€æŸ¥**
     - é¡µé¢è°ƒç”¨æ–¹æ³•åä¸Storeå¯¼å‡ºæ–¹æ³•åä¸€è‡´
     - æ–¹æ³•å‚æ•°ç­¾ååŒ¹é…
     - è¿”å›å€¼ç±»å‹ä¸€è‡´æ€§
     - å¼‚æ­¥å¤„ç†é€»è¾‘å®Œæ•´

4. **é€šçŸ¥ç³»ç»Ÿå®¡æ ¸**
   - æ¨é€é€šçŸ¥å®Œæ•´æ€§
   - é€šçŸ¥å¯¼èˆªè¦†ç›–

5. **UI å±•ç¤ºå®¡æ ¸**
   - æ•°æ®ç»‘å®šå‡†ç¡®æ€§
   - çŠ¶æ€å±•ç¤ºæ­£ç¡®æ€§
   - äº¤äº’åé¦ˆåˆç†æ€§

### å¸¸è§é—®é¢˜ç±»å‹

| é—®é¢˜ç±»å‹ | æ£€æŸ¥ä½ç½® | å…¸å‹é”™è¯¯ |
|---------|---------|---------|
| æ–¹æ³•åä¸å­˜åœ¨ | é¡µé¢è°ƒç”¨ Store | `sendFriendRequest` vs `sendRequest` |
| å­—æ®µåä¸åŒ¹é… | Payload ç±»å‹ | `kickedBy` vs `operatorId` |
| äº‹ä»¶æœªç»‘å®š | App.tsx | ç¼ºå°‘ `setupGroupListeners()` è°ƒç”¨ |
| ç±»å‹ä¸åŒ¹é… | åµŒå¥—å¯¹è±¡ | `member: GroupMember` vs `member: {id,name}` |
| å¯¼èˆªç¼ºå¤± | notificationStore | ç¼ºå°‘ `group_kicked` case |
| å­—æ®µè®¿é—®é”™è¯¯ | é¡µé¢æ¸²æŸ“ | `item.account` (ä¸å­˜åœ¨) |

---

## ğŸ”„ æ›´æ–°è®°å½•

| æ—¥æœŸ | æ“ä½œäºº | å†…å®¹ |
|------|--------|------|
| 2026-01-26 | AIåŠ©æ‰‹ | è®¤è¯æ¨¡å—ä¸APIæ¥å£æ¨¡å—å®¡æ ¸å®Œæˆï¼Œç¡®è®¤æµç¨‹å®‰å…¨ã€å­—æ®µå¯¹é½ã€æ–¹æ³•ç­¾åä¸€è‡´ |
| 2026-01-26 | AIåŠ©æ‰‹ | WebSocket æ¨¡å—å®¡æ ¸å®Œæˆï¼Œä¿®å¤å‰åç«¯ Payload ç±»å‹ä¸ä¸€è‡´é—®é¢˜ |
| 2026-01-25 | AIåŠ©æ‰‹ | åˆ›å»ºå®¡æ ¸æ¸…å•ï¼Œè®°å½• User å’Œ Role æ¨¡å—å®¡æ ¸å®Œæˆ |
