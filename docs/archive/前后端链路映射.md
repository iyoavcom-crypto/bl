# å‰åç«¯é“¾è·¯ç»“æ„æ˜ å°„æ–‡æ¡£

> ç”Ÿæˆæ—¶é—´: 2026-01-28
> åç«¯è·¯å¾„: `im/`
> å‰ç«¯è·¯å¾„: `my-app/`

---

## 1. WebSocket äº‹ä»¶é“¾è·¯

### 1.1 äº‹ä»¶ç±»å‹å®šä¹‰å¯¹ç…§

| äº‹ä»¶åç§° | åç«¯ç±»å‹å¸¸é‡ | å‰ç«¯ç±»å‹å­—ç¬¦ä¸² | çŠ¶æ€ |
|---------|------------|--------------|------|
| **æ¶ˆæ¯äº‹ä»¶** |
| æ–°æ¶ˆæ¯ | `WsEventType.MESSAGE_NEW` | `'message:new'` | âœ… ä¸€è‡´ |
| æ’¤å›æ¶ˆæ¯ | `WsEventType.MESSAGE_RECALLED` | `'message:recalled'` | âœ… ä¸€è‡´ |
| å·²è¯»æ¶ˆæ¯ | `WsEventType.MESSAGE_READ` | `'message:read'` | âœ… ä¸€è‡´ |
| å·²é€è¾¾æ¶ˆæ¯ | `WsEventType.MESSAGE_DELIVERED` | `'message:delivered'` | âœ… ä¸€è‡´ |
| **é€šè¯äº‹ä»¶** |
| å‘èµ·é€šè¯ | `WsEventType.CALL_INVITE` | `'call:invite'` | âœ… ä¸€è‡´ |
| å“é“ƒ | `WsEventType.CALL_RING` | `'call:ring'` | âœ… ä¸€è‡´ |
| æ¥å¬ | `WsEventType.CALL_ANSWER` | `'call:answer'` | âœ… ä¸€è‡´ |
| æ‹’æ¥ | `WsEventType.CALL_REJECT` | `'call:reject'` | âœ… ä¸€è‡´ |
| æŒ‚æ–­ | `WsEventType.CALL_END` | `'call:end'` | âœ… ä¸€è‡´ |
| ä¿¡ä»¤ | `WsEventType.CALL_SIGNAL` | `'call:signal'` | âœ… ä¸€è‡´ |
| **è¾“å…¥çŠ¶æ€** |
| å¼€å§‹è¾“å…¥ | `WsEventType.TYPING_START` | `'typing:start'` | âœ… ä¸€è‡´ |
| åœæ­¢è¾“å…¥ | `WsEventType.TYPING_STOP` | `'typing:stop'` | âœ… ä¸€è‡´ |
| **åœ¨çº¿çŠ¶æ€** |
| ä¸Šçº¿ | `WsEventType.PRESENCE_ONLINE` | `'presence:online'` | âœ… ä¸€è‡´ |
| ä¸‹çº¿ | `WsEventType.PRESENCE_OFFLINE` | `'presence:offline'` | âœ… ä¸€è‡´ |
| **å¥½å‹äº‹ä»¶** |
| å¥½å‹è¯·æ±‚ | `WsEventType.FRIEND_REQUEST` | `'friend:request'` | âœ… ä¸€è‡´ |
| å¥½å‹é€šè¿‡ | `WsEventType.FRIEND_ACCEPTED` | `'friend:accepted'` | âœ… ä¸€è‡´ |
| **ç¾¤ç»„äº‹ä»¶** |
| è¢«é‚€è¯·å…¥ç¾¤ | `WsEventType.GROUP_INVITED` | `'group:invited'` | âœ… ä¸€è‡´ |
| è¢«è¸¢å‡ºç¾¤ | `WsEventType.GROUP_KICKED` | `'group:kicked'` | âœ… ä¸€è‡´ |
| æˆå‘˜åŠ å…¥ | `WsEventType.GROUP_MEMBER_JOINED` | `'group:member_joined'` | âœ… ä¸€è‡´ |
| æˆå‘˜ç¦»å¼€ | `WsEventType.GROUP_MEMBER_LEFT` | `'group:member_left'` | âœ… ä¸€è‡´ |
| ç¾¤ç»„æ›´æ–° | `WsEventType.GROUP_UPDATED` | `'group:updated'` | âœ… ä¸€è‡´ |
| ç¾¤ç»„ç¦è¨€ | `WsEventType.GROUP_MUTED` | `'group:muted'` | âœ… ä¸€è‡´ |
| å–æ¶ˆç¦è¨€ | `WsEventType.GROUP_UNMUTED` | `'group:unmuted'` | âœ… ä¸€è‡´ |
| ç¾¤ç»„è§£æ•£ | `WsEventType.GROUP_DISSOLVED` | `'group:dissolved'` | âœ… ä¸€è‡´ |
| **ç³»ç»Ÿäº‹ä»¶** |
| è¿æ¥æˆåŠŸ | `WsEventType.CONNECTED` | `'connected'` | âœ… ä¸€è‡´ |
| é”™è¯¯ | `WsEventType.ERROR` | `'error'` | âœ… ä¸€è‡´ |
| è¢«è¸¢ä¸‹çº¿ | `WsEventType.KICK` | `'kick'` | âœ… ä¸€è‡´ |
| å¿ƒè·³å“åº” | `WsEventType.HEARTBEAT_ACK` | `'heartbeat:ack'` | âœ… ä¸€è‡´ |

**æ–‡ä»¶ä½ç½®:**
- åç«¯: `im/src/websocket/events/types.ts`
- å‰ç«¯: `my-app/src/types/websocket.ts`

---

### 1.2 Payload æ¥å£å¯¹ç…§

#### ç³»ç»Ÿäº‹ä»¶ Payload

| Payload ç±»å‹ | åç«¯æ¥å£ | å‰ç«¯æ¥å£ | å­—æ®µå¯¹ç…§ |
|------------|---------|---------|---------|
| è¿æ¥æˆåŠŸ | `WsConnectedPayload` | `WsConnectedPayload` | âœ… userId, deviceId, serverTime |
| è¢«è¸¢ä¸‹çº¿ | `WsKickPayload` | `WsKickPayload` | âœ… reason, newDeviceId? |
| é”™è¯¯ | `WsErrorPayload` | `WsErrorPayload` | âœ… code, message, details? |
| å¿ƒè·³å“åº” | `WsHeartbeatAckPayload` | `WsHeartbeatAckPayload` | âœ… serverTime |

**æ–‡ä»¶ä½ç½®:**
- åç«¯: `im/src/websocket/events/types.ts` (line 71-102)
- å‰ç«¯: `my-app/src/types/websocket.ts` (line 52-91)

---

#### è¾“å…¥çŠ¶æ€ Payload

| Payload ç±»å‹ | åç«¯æ¥å£ | å‰ç«¯æ¥å£ | å­—æ®µå¯¹ç…§ | çŠ¶æ€ |
|------------|---------|---------|---------|------|
| å¼€å§‹è¾“å…¥ | `TypingStartPayload` | `WsTypingPayload` | conversationId, userId, startedAt | âš ï¸ éœ€æ£€æŸ¥ |
| åœæ­¢è¾“å…¥ | `TypingStopPayload` | `WsTypingPayload` | conversationId, userId, stoppedAt | âš ï¸ éœ€æ£€æŸ¥ |

**å·®å¼‚è¯´æ˜:**
- åç«¯: åˆ†ä¸º `TypingStartPayload` (startedAtå¿…å¡«) å’Œ `TypingStopPayload` (stoppedAtå¿…å¡«)
- å‰ç«¯: åˆå¹¶ä¸º `WsTypingPayload` (startedAt?, stoppedAt? å‡å¯é€‰)

**æ–‡ä»¶ä½ç½®:**
- åç«¯: `im/src/websocket/events/typing.ts` (line 10-27)
- å‰ç«¯: `my-app/src/types/websocket.ts` (line 59-65)

---

#### åœ¨çº¿çŠ¶æ€ Payload

| Payload ç±»å‹ | åç«¯æ¥å£ | å‰ç«¯æ¥å£ | å­—æ®µå¯¹ç…§ | çŠ¶æ€ |
|------------|---------|---------|---------|------|
| ä¸Šçº¿ | `PresenceOnlinePayload` | `WsPresencePayload` | userId, deviceId, onlineAt | âš ï¸ éœ€æ£€æŸ¥ |
| ä¸‹çº¿ | `PresenceOfflinePayload` | `WsPresencePayload` | userId, deviceId, offlineAt | âš ï¸ éœ€æ£€æŸ¥ |

**å·®å¼‚è¯´æ˜:**
- åç«¯: åˆ†ä¸º `PresenceOnlinePayload` (onlineAtå¿…å¡«) å’Œ `PresenceOfflinePayload` (offlineAtå¿…å¡«)
- å‰ç«¯: åˆå¹¶ä¸º `WsPresencePayload` (onlineAt?, offlineAt? å‡å¯é€‰)

**æ–‡ä»¶ä½ç½®:**
- åç«¯: `im/src/websocket/events/presence.ts` (line 10-27)
- å‰ç«¯: `my-app/src/types/websocket.ts` (line 67-73)

---

#### æ¶ˆæ¯äº‹ä»¶ Payload (å¾…è¡¥å……)

**éœ€è¦è¯»å–çš„æ–‡ä»¶:**
- åç«¯: `im/src/websocket/events/message.ts`
- å‰ç«¯: `my-app/src/types/message.ts` + `my-app/src/types/websocket.ts`

---

#### å¥½å‹äº‹ä»¶ Payload (å¾…è¡¥å……)

**éœ€è¦è¯»å–çš„æ–‡ä»¶:**
- åç«¯: `im/src/websocket/events/friend.ts`
- å‰ç«¯: `my-app/src/types/friend.ts` + `my-app/src/types/websocket.ts`

---

#### ç¾¤ç»„äº‹ä»¶ Payload (å¾…è¡¥å……)

**éœ€è¦è¯»å–çš„æ–‡ä»¶:**
- åç«¯: `im/src/websocket/events/group.ts`
- å‰ç«¯: `my-app/src/types/group.ts` + `my-app/src/types/websocket.ts`

---

#### é€šè¯äº‹ä»¶ Payload (å¾…è¡¥å……)

**éœ€è¦è¯»å–çš„æ–‡ä»¶:**
- åç«¯: `im/src/websocket/events/call.ts`
- å‰ç«¯: `my-app/src/types/call.ts` + `my-app/src/types/websocket.ts`

---

### 1.3 WebSocket ç›‘å¬å™¨æ˜ å°„ (å¾…è¡¥å……)

**éœ€è¦æ£€æŸ¥çš„æ–‡ä»¶:**
- å‰ç«¯ Store: `my-app/src/stores/*Store.ts` (æ‰€æœ‰ Store æ–‡ä»¶)
- å‰ç«¯å…¥å£: `my-app/App.tsx` (æ£€æŸ¥ setupWsListeners è°ƒç”¨)
- WebSocket ç®¡ç†å™¨: `my-app/src/services/websocket/manager.ts`

**éœ€è¦éªŒè¯:**
- [ ] æ¯ä¸ª Store æ˜¯å¦æœ‰ `setupWsListeners` æ–¹æ³•
- [ ] App.tsx æ˜¯å¦è°ƒç”¨äº†æ‰€æœ‰ Store çš„ setupWsListeners
- [ ] ç›‘å¬çš„äº‹ä»¶ç±»å‹æ˜¯å¦ä¸åç«¯è§¦å‘çš„äº‹ä»¶åŒ¹é…

---

## 2. REST API é“¾è·¯

### 2.1 æ¨¡å—è·¯ç”±æ˜ å°„

| æ¨¡å— | åç«¯è·¯ç”±å‰ç¼€ | API æ•°é‡ | å‰ç«¯ Store | å·²æ˜ å°„ |
|-----|------------|---------|-----------|--------|
| è®¤è¯ | `/api/auth` | 4 | `authStore.ts` | å¾…è¡¥å…… |
| ç”¨æˆ· | `/api/im/users` | 7 | `userStore.ts` | å¾…è¡¥å…… |
| è®¾å¤‡ | `/api/im/devices` | 8 | `deviceStore.ts` | å¾…è¡¥å…… |
| å¥½å‹ | `/api/im/friends` | 10 | `friendStore.ts` | å¾…è¡¥å…… |
| å¥½å‹ç”³è¯· | `/api/im/friend-requests` | 5 | `friendStore.ts` | å¾…è¡¥å…… |
| ç¾¤ç»„ | `/api/im/groups` | 14 | `groupStore.ts` | å¾…è¡¥å…… |
| ç¾¤æˆå‘˜ | `/api/im/group-members` | 5 | `groupStore.ts` | å¾…è¡¥å…… |
| ä¼šè¯ | `/api/im/conversations` | 6 | `conversationStore.ts` | å¾…è¡¥å…… |
| æ¶ˆæ¯ | `/api/im/messages` | 9 | `messageStore.ts` | å¾…è¡¥å…… |
| é€šè¯ | `/api/im/calls` | 8 | `callStore.ts` | å¾…è¡¥å…… |
| åœ¨çº¿çŠ¶æ€ | `/api/im/presence` | 4 | `presenceStore.ts` | å¾…è¡¥å…… |
| åª’ä½“æ–‡ä»¶ | `/api/im/media` | 4 | `mediaStore.ts` | å¾…è¡¥å…… |

**æ€»è®¡:** 84 ä¸ª API

---

### 2.2 å…·ä½“ API æ˜ å°„ (å¾…è¡¥å……)

**æ˜ å°„æ ¼å¼:**
```markdown
#### APIåç§°
- **åç«¯è·¯ç”±**: `METHOD /api/path`
- **åç«¯æ§åˆ¶å™¨**: `im/src/contracts/xxx.controller.ts:line`
- **å‰ç«¯æ–¹æ³•**: `my-app/src/stores/xxxStore.ts::methodName`
- **è¯·æ±‚å‚æ•°å¯¹ç…§**: 
  - åç«¯æœŸæœ›: `{ field1: type, field2: type }`
  - å‰ç«¯å‘é€: `{ field1: type, field2: type }`
  - çŠ¶æ€: âœ… ä¸€è‡´ / âŒ ä¸ä¸€è‡´
- **å“åº”æ•°æ®å¯¹ç…§**:
  - åç«¯è¿”å›: `{ data: {...} }`
  - å‰ç«¯å¤„ç†: Store æ›´æ–°é€»è¾‘
  - çŠ¶æ€: âœ… ä¸€è‡´ / âŒ ä¸ä¸€è‡´
```

---

## 3. æ•°æ®æ¨¡å‹æ˜ å°„

### 3.1 æ ¸å¿ƒå®ä½“å¯¹ç…§

| å®ä½“ç±»å‹ | åç«¯æ¨¡å‹ | å‰ç«¯ç±»å‹ | å·²å¯¹æ¯” |
|---------|---------|---------|--------|
| ç”¨æˆ· | `im/src/models/user` | `my-app/src/types/user.ts` | å¾…è¡¥å…… |
| æ¶ˆæ¯ | `im/src/models/message` | `my-app/src/types/message.ts` | å¾…è¡¥å…… |
| ä¼šè¯ | `im/src/models/conversation` | `my-app/src/types/conversation.ts` | å¾…è¡¥å…… |
| å¥½å‹ | `im/src/models/friend` | `my-app/src/types/friend.ts` | å¾…è¡¥å…… |
| ç¾¤ç»„ | `im/src/models/group` | `my-app/src/types/group.ts` | å¾…è¡¥å…… |
| è®¾å¤‡ | `im/src/models/device` | `my-app/src/types/device.ts` | å¾…è¡¥å…… |
| é€šè¯ | `im/src/models/call` | `my-app/src/types/call.ts` | å¾…è¡¥å…… |

---

### 3.2 å­—æ®µæ˜ å°„æ¨¡æ¿ (å¾…è¡¥å……)

**æ˜ å°„æ ¼å¼:**
```markdown
#### User å®ä½“
| å­—æ®µå | åç«¯ç±»å‹ | å‰ç«¯ç±»å‹ | æ˜¯å¦ä¸€è‡´ | å¤‡æ³¨ |
|-------|---------|---------|---------|------|
| id | string | string | âœ… | UUID |
| name | string | string | âœ… | ç”¨æˆ·å |
| avatar | string \| null | string \| null | âœ… | å¤´åƒURL |
```

---

## 4. é€šçŸ¥ç³»ç»Ÿé“¾è·¯ (å¾…è¡¥å……)

### 4.1 æ¨é€é€šçŸ¥ç±»å‹æ˜ å°„

**éœ€è¦å¯¹æ¯”çš„æ–‡ä»¶:**
- åç«¯æ¨é€: `im/src/services/push/index.ts` + `im/src/services/push/expo.ts`
- å‰ç«¯ç±»å‹: `my-app/src/types/notification.ts`
- å‰ç«¯å¤„ç†: (éœ€è¦æŸ¥æ‰¾ notification handler)

---

## 5. å®¡æ ¸æ¸…å•

### 5.1 WebSocket äº‹ä»¶å®¡æ ¸

- [x] äº‹ä»¶ç±»å‹åç§°ä¸€è‡´æ€§ âœ… å…¨éƒ¨ä¸€è‡´
- [ ] Payload å­—æ®µå®Œæ•´å¯¹ç…§ (éƒ¨åˆ†å®Œæˆ)
- [ ] ç›‘å¬å™¨ç»‘å®šæ£€æŸ¥
- [ ] App.tsx åˆå§‹åŒ–æ£€æŸ¥

### 5.2 REST API å®¡æ ¸

- [ ] è·¯ç”±è·¯å¾„å¯¹ç…§
- [ ] è¯·æ±‚å‚æ•°ä¸€è‡´æ€§
- [ ] å“åº”æ•°æ®ç»“æ„ä¸€è‡´æ€§
- [ ] é”™è¯¯å¤„ç†ä¸€è‡´æ€§

### 5.3 æ•°æ®æ¨¡å‹å®¡æ ¸

- [ ] å­—æ®µåç§°å¯¹ç…§
- [ ] å­—æ®µç±»å‹å¯¹ç…§
- [ ] å¯é€‰/å¿…å¡«å¯¹ç…§
- [ ] åµŒå¥—å¯¹è±¡ç»“æ„å¯¹ç…§

### 5.4 é€šçŸ¥ç³»ç»Ÿå®¡æ ¸

- [ ] æ¨é€åœºæ™¯è¦†ç›–
- [ ] NotificationType å¯¹ç…§
- [ ] å¯¼èˆªè·¯ç”±å¯¹ç…§

---

## 6. ä¸‹ä¸€æ­¥æ“ä½œ

1. **è¡¥å…… Payload è¯¦ç»†å¯¹ç…§**
   - è¯»å– `im/src/websocket/events/message.ts`
   - è¯»å– `im/src/websocket/events/friend.ts`
   - è¯»å– `im/src/websocket/events/group.ts`
   - è¯»å– `im/src/websocket/events/call.ts`

2. **è¡¥å…… Store ç›‘å¬å™¨æ˜ å°„**
   - è¯»å–æ‰€æœ‰å‰ç«¯ Store æ–‡ä»¶
   - æå– `setupWsListeners` æ–¹æ³•
   - è®°å½•ç›‘å¬çš„äº‹ä»¶ç±»å‹

3. **è¡¥å…… REST API æ˜ å°„**
   - æ ¹æ® API-ROUTES.md é€ä¸ªæ˜ å°„
   - æŸ¥æ‰¾å¯¹åº”çš„å‰ç«¯ Store æ–¹æ³•
   - å¯¹æ¯”è¯·æ±‚/å“åº”æ•°æ®ç»“æ„

4. **è¡¥å……æ•°æ®æ¨¡å‹å¯¹ç…§**
   - è¯»å–åç«¯ models ç›®å½•
   - å¯¹æ¯”å‰ç«¯ types ç›®å½•
   - è®°å½•å­—æ®µå·®å¼‚

---

## 7. å·²å‘ç°çš„é—®é¢˜

### é—®é¢˜ 1: è¾“å…¥çŠ¶æ€ Payload ä¸ä¸€è‡´
- **ä½ç½®**: Typing Payload
- **åç«¯**: åˆ†ä¸º TypingStartPayload å’Œ TypingStopPayload
- **å‰ç«¯**: åˆå¹¶ä¸º WsTypingPayload
- **å½±å“**: å‰ç«¯éœ€è¦åŒæ—¶å¤„ç† start å’Œ stop äº‹ä»¶
- **å»ºè®®**: éªŒè¯å‰ç«¯æ˜¯å¦æ­£ç¡®åŒºåˆ†ä¸¤ç§äº‹ä»¶

### é—®é¢˜ 2: åœ¨çº¿çŠ¶æ€ Payload ä¸ä¸€è‡´
- **ä½ç½®**: Presence Payload
- **åç«¯**: åˆ†ä¸º PresenceOnlinePayload å’Œ PresenceOfflinePayload
- **å‰ç«¯**: åˆå¹¶ä¸º WsPresencePayload
- **å½±å“**: åŒä¸Š
- **å»ºè®®**: åŒä¸Š

---

**æ–‡æ¡£çŠ¶æ€**: ğŸš§ æ–½å·¥ä¸­ - åŸºç¡€æ¡†æ¶å·²å»ºç«‹,å¾…è¡¥å……è¯¦ç»†å†…å®¹
